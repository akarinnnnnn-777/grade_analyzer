<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>成績表分析アプリ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            background: #fafafa;
        }
        
        .upload-area:hover {
            border-color: #999;
        }
        
        .upload-area input[type="file"] {
            display: none;
        }
        
        .upload-btn {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .upload-btn:hover {
            background: #0056b3;
        }
        
        .student-info {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .student-name {
            font-size: 24px;
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 10px;
        }
        
        .unit-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .unit-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .grade-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }
        
        .grade-table th,
        .grade-table td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: left;
        }
        
        .grade-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        
        .subdued {
            color: #666;
            font-size: 0.9em;
        }
        
        .grade-P { background-color: #b3e5fc; }
        .grade-F { background-color: #f8bbd9; }
        .grade-A\+ { background-color: #bbdefb; }
        .grade-A { background-color: #c8e6c9; }
        .grade-B { background-color: #fff9c4; }
        .grade-C { background-color: #ffcc80; }
        .grade-D { background-color: #ffab80; }
        .grade-履修中 { background-color: #f0f0f0; }
        
        .stats-container {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .gpa-section {
            flex: 1;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }
        
        .gpa-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .gpa-table th,
        .gpa-table td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: center;
        }
        
        .gpa-table th {
            background: #e9ecef;
        }
        
        .gpa-result {
            background: #007bff;
            color: white;
            font-size: 24px;
            font-weight: bold;
            vertical-align: middle;
        }
        
        .percentage-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }
        
        .percentage-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .percentage-table th,
        .percentage-table td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: center;
        }
        
        .percentage-table th {
            background: #e9ecef;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>成績表分析アプリ 📊</h1>
        
        <div class="upload-area" id="uploadArea">
            <input type="file" id="fileInput" accept=".csv" />
            <p>CSVファイルをドラッグ&ドロップするか、下のボタンをクリックしてファイルを選択してください</p>
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                ファイルを選択
            </button>
        </div>
        
        <div id="results" class="hidden">
            <div class="student-info">
                <div class="student-name" id="studentName"></div>
                <div class="unit-info" id="unitInfo"></div>
            </div>
            
            <table class="grade-table" id="gradeTable">
                <thead>
                    <tr>
                        <th>科目番号</th>
                        <th>科目名</th>
                        <th>単位数</th>
                        <th>春学期</th>
                        <th>秋学期</th>
                        <th>総合評価</th>
                        <th class="subdued">科目区分</th>
                        <th class="subdued">開講年度</th>
                        <th class="subdued">開講区分</th>
                    </tr>
                </thead>
                <tbody id="gradeTableBody"></tbody>
            </table>
            
            <div class="stats-container">
                <div class="gpa-section">
                    <h3>【上限4.3のGPA】</h3>
                    <table class="gpa-table">
                        <thead>
                            <tr>
                                <th>評価</th>
                                <th>ポイント</th>
                                <th>単位数</th>
                                <th>GPA</th>
                            </tr>
                        </thead>
                        <tbody id="gpa43Body">
                            <tr>
                                <td>A+</td>
                                <td>4.3</td>
                                <td id="aplus43Units">0</td>
                                <td rowspan="6" class="gpa-result" id="gpa43Result">0.00</td>
                            </tr>
                            <tr>
                                <td>A</td>
                                <td>4.0</td>
                                <td id="a43Units">0</td>
                            </tr>
                            <tr>
                                <td>B</td>
                                <td>3.0</td>
                                <td id="b43Units">0</td>
                            </tr>
                            <tr>
                                <td>C</td>
                                <td>2.0</td>
                                <td id="c43Units">0</td>
                            </tr>
                            <tr>
                                <td>D</td>
                                <td>0.0</td>
                                <td id="d43Units">0</td>
                            </tr>
                            <tr>
                                <td><strong>合計</strong></td>
                                <td>-</td>
                                <td id="total43Units">0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="gpa-section">
                    <h3>【上限4.0のGPA】</h3>
                    <table class="gpa-table">
                        <thead>
                            <tr>
                                <th>評価</th>
                                <th>ポイント</th>
                                <th>単位数</th>
                                <th>GPA</th>
                            </tr>
                        </thead>
                        <tbody id="gpa40Body">
                            <tr>
                                <td>A+</td>
                                <td>4.0</td>
                                <td id="aplus40Units">0</td>
                                <td rowspan="6" class="gpa-result" id="gpa40Result">0.00</td>
                            </tr>
                            <tr>
                                <td>A</td>
                                <td>3.0</td>
                                <td id="a40Units">0</td>
                            </tr>
                            <tr>
                                <td>B</td>
                                <td>2.0</td>
                                <td id="b40Units">0</td>
                            </tr>
                            <tr>
                                <td>C</td>
                                <td>1.0</td>
                                <td id="c40Units">0</td>
                            </tr>
                            <tr>
                                <td>D</td>
                                <td>0.0</td>
                                <td id="d40Units">0</td>
                            </tr>
                            <tr>
                                <td><strong>合計</strong></td>
                                <td>-</td>
                                <td id="total40Units">0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="percentage-section">
                <h3>成績評定の割合</h3>
                <p style="font-size: 0.9em; color: #666;">※母数からP・Fを除く</p>
                <table class="percentage-table">
                    <thead>
                        <tr>
                            <th>評価</th>
                            <th>割合</th>
                            <th>この評価以上</th>
                        </tr>
                    </thead>
                    <tbody id="percentageBody">
                        <tr>
                            <td>A+</td>
                            <td id="aplusPercent">0%</td>
                            <td id="aplusAbove">0%</td>
                        </tr>
                        <tr>
                            <td>A</td>
                            <td id="aPercent">0%</td>
                            <td id="aAbove">0%</td>
                        </tr>
                        <tr>
                            <td>B</td>
                            <td id="bPercent">0%</td>
                            <td id="bAbove">0%</td>
                        </tr>
                        <tr>
                            <td>C</td>
                            <td id="cPercent">0%</td>
                            <td id="cAbove">0%</td>
                        </tr>
                        <tr>
                            <td>D</td>
                            <td id="dPercent">0%</td>
                            <td id="dAbove">0%</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script>
        let csvData = null;
        let studentInfo = null;

        // ファイルアップロード処理
        document.getElementById('fileInput').addEventListener('change', handleFile);
        
        // ドラッグ&ドロップ処理
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#007bff';
        });
        
        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#ccc';
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#ccc';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile({ target: { files: files } });
            }
        });

        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const csvText = e.target.result;
                parseCSV(csvText);
            };
            reader.readAsText(file, 'UTF-8');
        }

        function parseCSV(csvText) {
            Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    csvData = results.data;
                    if (csvData.length > 0) {
                        studentInfo = {
                            name: csvData[0]['学生氏名'],
                            number: csvData[0]['学籍番号']
                        };
                        displayResults();
                    }
                }
            });
        }

        function displayResults() {
            // 学生情報を表示
            document.getElementById('studentName').textContent = 
                `${studentInfo.name}（${studentInfo.number}）さんの成績`;
            
            // 単位情報を計算・表示
            displayUnitInfo();
            
            // 成績表を表示
            displayGradeTable();
            
            // GPA計算
            calculateGPA();
            
            // 成績割合計算
            calculatePercentage();
            
            // 結果を表示
            document.getElementById('results').classList.remove('hidden');
        }

        function displayUnitInfo() {
            const unitsByYear = {};
            let totalEarned = 0;
            let totalEnrolled = 0;

            csvData.forEach(row => {
                const year = row['開講年度'];
                const units = parseFloat(row['単位数']) || 0;
                const grade = row['総合評価'];
                
                if (!unitsByYear[year]) {
                    unitsByYear[year] = { earned: 0, enrolled: 0 };
                }
                
                unitsByYear[year].enrolled += units;
                totalEnrolled += units;
                
                if (grade && grade !== 'D' && grade !== 'F' && grade !== '履修中') {
                    unitsByYear[year].earned += units;
                    totalEarned += units;
                }
            });

            let unitInfoHTML = '';
            Object.keys(unitsByYear).sort().forEach(year => {
                const yearData = unitsByYear[year];
                unitInfoHTML += `
                    <div class="unit-row">
                        <span>${year}年度:</span>
                        <span>修得 ${yearData.earned}単位 / 履修 ${yearData.enrolled}単位</span>
                    </div>
                `;
            });
            
            unitInfoHTML += `
                <div class="unit-row" style="border-top: 1px solid #ddd; padding-top: 10px; margin-top: 10px;">
                    <span><strong>累計:</strong></span>
                    <span><strong>修得 ${totalEarned}単位 / 履修 ${totalEnrolled}単位</strong></span>
                </div>
            `;
            
            document.getElementById('unitInfo').innerHTML = unitInfoHTML;
        }

        function displayGradeTable() {
            const tableBody = document.getElementById('gradeTableBody');
            tableBody.innerHTML = '';

            csvData.forEach(row => {
                const tr = document.createElement('tr');
                const grade = row['総合評価'];
                
                tr.innerHTML = `
                    <td>${row['科目番号']}</td>
                    <td>${row['科目名 ']}</td>
                    <td>${row['単位数']}</td>
                    <td>${row['春学期'] || '-'}</td>
                    <td>${row['秋学期'] || '-'}</td>
                    <td class="grade-${grade}">${grade}</td>
                    <td class="subdued">${row['科目区分']}</td>
                    <td class="subdued">${row['開講年度']}</td>
                    <td class="subdued">${row['開講区分']}</td>
                `;
                
                tableBody.appendChild(tr);
            });
        }

        function calculateGPA() {
            const gradePoints43 = { 'A+': 4.3, 'A': 4.0, 'B': 3.0, 'C': 2.0, 'D': 0.0 };
            const gradePoints40 = { 'A+': 4.0, 'A': 3.0, 'B': 2.0, 'C': 1.0, 'D': 0.0 };
            
            const gradeCounts = { 'A+': 0, 'A': 0, 'B': 0, 'C': 0, 'D': 0 };
            const gradeUnits = { 'A+': 0, 'A': 0, 'B': 0, 'C': 0, 'D': 0 };
            
            let totalPoints43 = 0;
            let totalPoints40 = 0;
            let totalUnits = 0;

            csvData.forEach(row => {
                const grade = row['総合評価'];
                const units = parseFloat(row['単位数']) || 0;
                
                if (gradePoints43.hasOwnProperty(grade)) {
                    gradeCounts[grade]++;
                    gradeUnits[grade] += units;
                    totalPoints43 += gradePoints43[grade] * units;
                    totalPoints40 += gradePoints40[grade] * units;
                    totalUnits += units;
                }
            });

            // 4.3スケールGPA表示
            document.getElementById('aplus43Units').textContent = gradeUnits['A+'];
            document.getElementById('a43Units').textContent = gradeUnits['A'];
            document.getElementById('b43Units').textContent = gradeUnits['B'];
            document.getElementById('c43Units').textContent = gradeUnits['C'];
            document.getElementById('d43Units').textContent = gradeUnits['D'];
            document.getElementById('total43Units').textContent = totalUnits;
            document.getElementById('gpa43Result').textContent = totalUnits > 0 ? (totalPoints43 / totalUnits).toFixed(2) : '0.00';

            // 4.0スケールGPA表示
            document.getElementById('aplus40Units').textContent = gradeUnits['A+'];
            document.getElementById('a40Units').textContent = gradeUnits['A'];
            document.getElementById('b40Units').textContent = gradeUnits['B'];
            document.getElementById('c40Units').textContent = gradeUnits['C'];
            document.getElementById('d40Units').textContent = gradeUnits['D'];
            document.getElementById('total40Units').textContent = totalUnits;
            document.getElementById('gpa40Result').textContent = totalUnits > 0 ? (totalPoints40 / totalUnits).toFixed(2) : '0.00';
        }

        function calculatePercentage() {
            const gradeCounts = { 'A+': 0, 'A': 0, 'B': 0, 'C': 0, 'D': 0 };
            let totalGradedSubjects = 0;

            csvData.forEach(row => {
                const grade = row['総合評価'];
                if (gradeCounts.hasOwnProperty(grade)) {
                    gradeCounts[grade]++;
                    totalGradedSubjects++;
                }
            });

            if (totalGradedSubjects === 0) return;

            const percentages = {};
            Object.keys(gradeCounts).forEach(grade => {
                percentages[grade] = (gradeCounts[grade] / totalGradedSubjects * 100).toFixed(1);
            });

            // 個別の割合を表示
            document.getElementById('aplusPercent').textContent = percentages['A+'] + '%';
            document.getElementById('aPercent').textContent = percentages['A'] + '%';
            document.getElementById('bPercent').textContent = percentages['B'] + '%';
            document.getElementById('cPercent').textContent = percentages['C'] + '%';
            document.getElementById('dPercent').textContent = percentages['D'] + '%';

            // 「この評価以上」の計算
            const aplusAbove = parseFloat(percentages['A+']);
            const aAbove = aplusAbove + parseFloat(percentages['A']);
            const bAbove = aAbove + parseFloat(percentages['B']);
            const cAbove = bAbove + parseFloat(percentages['C']);
            const dAbove = cAbove + parseFloat(percentages['D']);

            document.getElementById('aplusAbove').textContent = aplusAbove.toFixed(1) + '%';
            document.getElementById('aAbove').textContent = aAbove.toFixed(1) + '%';
            document.getElementById('bAbove').textContent = bAbove.toFixed(1) + '%';
            document.getElementById('cAbove').textContent = cAbove.toFixed(1) + '%';
            document.getElementById('dAbove').textContent = dAbove.toFixed(1) + '%';
        }
    </script>
</body>
</html>
